version: '3.4'

# This Compose file is expected to be used with the devnet-up.sh script.
# The volumes below mount the configs generated by the script into each
# service.
# TODO: Authenticated ports don't seem to be working.
# TODO: Better backoff in the op-node would enable native dependencies rather
# than manually waiting for the L2 node to come up.

volumes:
  l2_data:
  op_log:


services:
  l2:
    build:
      context: .
      dockerfile: Dockerfile.l2
    ports:
      - "9545:8545"
      - "9546:8546"
    volumes:
      - "l2_data:/db"
      - ${PWD}/config/genesis-l2.json:/genesis.json
      - ${PWD}/.config/jwt-secret.txt:/config/jwt-secret.txt
    entrypoint:  # pass the L2 specific flags by overriding the entry-point and adding extra arguments
      - "/bin/sh"
      - "/entrypoint.sh"
      - "--authrpc.jwtsecret=/config/jwt-secret.txt"

  op-node:
    depends_on:
      - l2
    image: local-op-node:latest
    command: >
      op-node
      --l1=${L1_RPC_URL}
      --l2=ws://l2:8546
      --l2.jwt-secret=/jwt-secret.txt
      --verifier.l1-confs=0
      --rollup.config=/rollup.json
      --rpc.addr=0.0.0.0
      --rpc.port=8545
      --p2p.listen.ip=0.0.0.0
      --p2p.listen.tcp=9003
      --p2p.listen.udp=9003
      --metrics.enabled
      --metrics.addr=0.0.0.0
      --metrics.port=7300
    ports:
      - "7545:8545"
      - "9003:9003"
      - "7300:7300"
    volumes:
      - ${PWD}/.config/jwt-secret.txt:/jwt-secret.txt
      - ${PWD}/config/rollup.json:/rollup.json
      - op_log:/op_log
